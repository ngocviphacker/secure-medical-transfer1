<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ng∆∞·ªùi nh·∫≠n - Nh·∫≠n b·ªánh √°n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h2 class="text-success">üì• Nh·∫≠n g√≥i b·ªánh √°n</h2>

  <!-- Th√¥ng b√°o g√≥i m·ªõi -->
  <div id="notify" class="alert alert-info" style="display:none"></div>

  <!-- Nh·∫≠p m·∫≠t kh·∫©u -->
  <form id="autoForm" style="display:none">
    <div class="mb-3">
      <label class="form-label">üîê Nh·∫≠p m·∫≠t kh·∫©u x√°c th·ª±c:</label>
      <input type="password" class="form-control" id="receiver_password" required>
    </div>
    <button type="button" class="btn btn-success w-100" onclick="submitAuto()">üß™ X√°c th·ª±c & Gi·∫£i m√£</button>
  </form>

  <!-- K·∫øt qu·∫£ -->
  <div id="result" class="mt-4" style="display:none">
    <h5>K·∫øt qu·∫£ x√°c th·ª±c:</h5>
    <ul id="verify_steps" class="list-group mb-3"></ul>
    <a id="downloadBtn" class="btn btn-primary" href="#" style="display:none">‚¨áÔ∏è T·∫£i file ƒë√£ gi·∫£i m√£</a>
  </div>
</div>

<script>
  let packetData = null;
  const socket = io();

  socket.on('incoming_packet', data => {
    packetData = data;
    document.getElementById('notify').style.display = 'block';
    document.getElementById('notify').innerText = `üì® G√≥i tin m·ªõi t·ª´ ng∆∞·ªùi g·ª≠i: ${data.metadata.filename}`;
    document.getElementById('autoForm').style.display = 'block';
    document.getElementById('result').style.display = 'none';
  });

  function submitAuto() {
    const password = document.getElementById('receiver_password').value;
    if (!packetData || !password) return;

    packetData["receiver_password"] = password;

    const list = document.getElementById('verify_steps');
    list.innerHTML = '';
    document.getElementById('result').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'none';

    fetch('/receive_auto', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(packetData)
    })
    .then(res => res.text())
    .then(text => {
      const steps = {
        "hash": "‚úÖ To√†n v·∫πn (SHA-512) h·ª£p l·ªá",
        "pwd": "‚úÖ M·∫≠t kh·∫©u h·ª£p l·ªá",
        "sig": "‚úÖ Ch·ªØ k√Ω h·ª£p l·ªá",
        "fail_hash": "‚ùå Sai hash ‚Äì D·ªØ li·ªáu b·ªã thay ƒë·ªïi",
        "fail_pwd": "‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng",
        "fail_sig": "‚ùå Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá"
      };

      if (text.includes("Sai hash")) list.innerHTML += `<li class="list-group-item text-danger">${steps.fail_hash}</li>`;
      else list.innerHTML += `<li class="list-group-item text-success">${steps.hash}</li>`;

      if (text.includes("Sai m·∫≠t kh·∫©u")) list.innerHTML += `<li class="list-group-item text-danger">${steps.fail_pwd}</li>`;
      else list.innerHTML += `<li class="list-group-item text-success">${steps.pwd}</li>`;

      if (text.includes("Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá")) list.innerHTML += `<li class="list-group-item text-danger">${steps.fail_sig}</li>`;
      else list.innerHTML += `<li class="list-group-item text-success">${steps.sig}</li>`;

      // N·∫øu h·ª£p l·ªá ‚Äì cho t·∫£i file
      if (text.includes("th√†nh c√¥ng")) {
        document.getElementById('downloadBtn').href = `/download/${packetData.filename}`;
        document.getElementById('downloadBtn').style.display = 'inline-block';
      }
    });
  }
</script>
</body>
</html>
